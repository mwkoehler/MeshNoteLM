<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #525252;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #viewerContainer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        #pdfViewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .page {
            margin: 10px auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            background: white;
            position: relative;
        }

        .loadingIcon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #666;
        }

        canvas {
            display: block;
        }

        #loadingBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #4CAF50;
            transform-origin: left;
            transition: transform 0.3s;
            z-index: 1000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loadingBar"></div>
    <div id="viewerContainer">
        <div id="pdfViewer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageRendering = false;
        let pageNumPending = null;
        let currentScale = 1.0;
        let currentRotation = 0;

        const viewerContainer = document.getElementById('viewerContainer');
        const pdfViewer = document.getElementById('pdfViewer');
        const loadingBar = document.getElementById('loadingBar');

        // Global API for external control
        window.PDFViewerApplication = {
            pdfViewer: {
                currentPageNumber: 1,
                pagesCount: 0,
                currentScaleValue: 1.0,
                rotation: 0
            },
            open: loadPdf,
            setScale: setScale,
            rotateCW: rotateCW,
            rotateCCW: rotateCCW
        };

        async function loadPdf() {
            try {
                // Get PDF data from placeholder
                const pdfData = atob('{{PDF_DATA}}');
                const pdfArray = new Uint8Array(pdfData.length);
                for (let i = 0; i < pdfData.length; i++) {
                    pdfArray[i] = pdfData.charCodeAt(i);
                }

                loadingBar.style.transform = 'scaleX(0.5)';

                const loadingTask = pdfjsLib.getDocument({ data: pdfArray });

                loadingTask.onProgress = function(progress) {
                    if (progress.total > 0) {
                        const percent = progress.loaded / progress.total;
                        loadingBar.style.transform = `scaleX(${percent})`;
                    }
                };

                pdfDoc = await loadingTask.promise;
                window.PDFViewerApplication.pdfViewer.pagesCount = pdfDoc.numPages;

                loadingBar.classList.add('hidden');

                // Render all pages
                await renderAllPages();
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('Error loading PDF: ' + error.message);
            }
        }

        async function renderAllPages() {
            pdfViewer.innerHTML = '';

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.id = `page-${pageNum}`;

                const canvas = document.createElement('canvas');
                pageDiv.appendChild(canvas);
                pdfViewer.appendChild(pageDiv);

                await renderPage(pageNum, canvas);
            }
        }

        async function renderPage(pageNum, canvas) {
            try {
                const page = await pdfDoc.getPage(pageNum);

                const viewport = page.getViewport({
                    scale: currentScale * window.devicePixelRatio,
                    rotation: currentRotation
                });

                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = `${viewport.width / window.devicePixelRatio}px`;
                canvas.style.height = `${viewport.height / window.devicePixelRatio}px`;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
            } catch (error) {
                console.error(`Error rendering page ${pageNum}:`, error);
            }
        }

        async function setScale(scale) {
            currentScale = scale;
            window.PDFViewerApplication.pdfViewer.currentScaleValue = scale;
            if (pdfDoc) {
                await renderAllPages();
            }
        }

        async function rotateCW() {
            currentRotation = (currentRotation + 90) % 360;
            window.PDFViewerApplication.pdfViewer.rotation = currentRotation;
            if (pdfDoc) {
                await renderAllPages();
            }
        }

        async function rotateCCW() {
            currentRotation = (currentRotation - 90 + 360) % 360;
            window.PDFViewerApplication.pdfViewer.rotation = currentRotation;
            if (pdfDoc) {
                await renderAllPages();
            }
        }

        // Track current page based on scroll position
        viewerContainer.addEventListener('scroll', function() {
            const scrollTop = viewerContainer.scrollTop;
            const pages = document.querySelectorAll('.page');

            for (let i = 0; i < pages.length; i++) {
                const pageTop = pages[i].offsetTop;
                const pageBottom = pageTop + pages[i].offsetHeight;

                if (scrollTop >= pageTop && scrollTop < pageBottom) {
                    window.PDFViewerApplication.pdfViewer.currentPageNumber = i + 1;
                    break;
                }
            }
        });

        // Auto-load PDF when page loads
        window.addEventListener('load', function() {
            loadPdf();
        });

        // Handle pinch-to-zoom on mobile
        let initialDistance = 0;
        let initialScale = 1.0;

        viewerContainer.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                initialDistance = getDistance(e.touches[0], e.touches[1]);
                initialScale = currentScale;
            }
        });

        viewerContainer.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const distance = getDistance(e.touches[0], e.touches[1]);
                const scale = initialScale * (distance / initialDistance);
                const clampedScale = Math.max(0.5, Math.min(3.0, scale));
                setScale(clampedScale);
            }
        });

        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
    </script>
</body>
</html>
